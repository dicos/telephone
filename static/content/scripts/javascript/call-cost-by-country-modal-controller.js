(function () {
    var countries = [
        'Австралия', 'Американские острова Самоа', 'Аргентина', 'Австрия', 'Ангилья', 'Армения', 'Азербайджан',
        'Ангола', 'Аруба', 'Албания', 'Андорра', 'Афганистан', 'Алжир', 'Антарктика', 'Аляска', 'Антигуа и Барбуда',
        'Багамские острова', 'Бенин', 'Британские Виргинские острова', 'Бангладеш', 'Бермудские остова', 'Бруней',
        'Барбадос', 'Болгария', 'Буркина-Фасо', 'Бахрейн', 'Боливия', 'Бурунди', 'Беларусь', 'Босния и Герцеговина',
        'Бутан', 'Белиз', 'Ботсвана', 'Бельгия', 'Бразилия', 'Вануату', 'Венесуэла', 'Вьетнам', 'Великобритания',
        'Виргинские острова', 'Венгрия', 'Восточный Тимор', 'Габон', 'Гваделупа', 'Гонконг', 'Гаваи', 'Гватемала',
        'Гренада', 'Гаити', 'Гвинея', 'Гренландия', 'Гайана', 'Германия', 'Греция', 'Гамбия', 'Гибралтар', 'Грузия',
        'Гана', 'Гондурас', 'Гуам', 'Дания', 'Диего-Гарсия', 'Доминиканская Республика', 'Джибути', 'Доминика',
        'Египет', 'Замбия', 'Зимбабве', 'Западное Самоа', 'Израиль', 'Ирак', 'Испания', 'Индия', 'Иран', 'Италия',
        'Индонезия', 'Ирландия', 'Иордания', 'Исландия', 'Йемен', 'Кабо-Верде', 'Кения', 'Коста-Рика', 'Казахстан',
        'Кипр', 'Кот-д\'Ивуар', 'Каймановые острова', 'Кирибати', 'Куба', 'Камбоджа', 'Китай', 'Кувейт', 'Камерун',
        'Колумбия', 'Кыргызстан', 'Канада', 'Коморские острова', 'Катар', 'Конго', 'Лаос', 'Либерия', 'Литва', 'Латвия',
        'Ливан', 'Лихтенштейн', 'Лесото', 'Ливия', 'Люксембург', 'Маврикий остров', 'Малайзия', 'Микронезия',
        'Мавритания', 'Мали', 'Мозамбик', 'Мадагаскар', 'Мальдивы', 'Молдова', 'Майотта', 'Мальта', 'Монако', 'Макао',
        'Марокко', 'Монголия', 'Македония', 'Мартиника', 'Монтсеррат', 'Малави', 'Мексика', 'Мьянма', 'Намибия',
        'Нидерландские Антильские острова', 'Новая Каледония', 'Науру', 'Нидерланды', 'Норвегия', 'Непал', 'Никарагуа',
        'Норфолк', 'Нигер', 'Ниуэ', 'Нигерия', 'Новая Зеландия', 'Объединённые Арабские Эмираты', 'Остров Вознесения',
        'Острова Кука', 'Оман', 'Остров Святой Елены', 'Пакистан', 'Папуа-Новая Гвинея', 'Португалия', 'Палау',
        'Парагвай', 'Пуэрто-Рико', 'Палестина', 'Перу', 'Панама', 'Польша', 'Реюньон', 'Руанда', 'Россия', 'Румыния',
        'Сальвадор', 'Сент-Люсия', 'Сомали', 'Сан-Марино', 'Сербия', 'Судан', 'Саудовская Аравия', 'Сингапур',
        'Суринам', 'Свазиленд', 'Сирия', 'США', 'Северные Марианские острова', 'Словакия', 'Сьерра-Леоне', 'Сейшелы',
        'Словения', 'Сенегал', 'Соломоновы острова', 'Таджикистан', 'Того', 'Тунис', 'Таиланд', 'Токелау',
        'Туркменистан', 'Тайвань', 'Тонга', 'Турция', 'Танзания', 'Тувалу', 'Уганда', 'Украина', 'Узбекистан',
        'Уругвай', 'Фарерские острова', 'Филиппины', 'Фолклендские острова', 'Фиджи', 'Финляндия', 'Франция',
        'Хорватия', 'Центральноафриканская Республика', 'Чад', 'Чешская Республика', 'Черногория', 'Чили',
        'Швейцария', 'Шри-Ланка', 'Швеция', 'Эквадор', 'Эритрея', 'Эфиопия', 'Экваториальная Гвинея', 'Эстония',
        'Южная Африка', 'Ямайка', 'Япония'
    ];

    function _loadCallCosts (country) {
        function _addClass (className) {
            this.elements.forEach(function (item, i) {
                $(item).addClass(className)
            })
        }

        function _boundItem(item, boundName, row) {
            var valsArr = item.cost_5.split(/(\d{1}.[0-9]+)|([0-9]+)/);
            var cost = Number(valsArr[1] || valsArr[2]);

            if (this.value == undefined || (boundName === 'max' ? cost > this.value : cost < this.value)) {
                this.elements = [row];
                this.value = cost
            } else if (cost == this.value) {
                this.elements.push(row);
            }
        }

        $.get('/getCallCostByCountry/?country=' + country, function (result) {
            var id = 'call-cost-country-';
            var bodyContent = [];
            var maxItem = { elements: [], value: undefined };
            var minItem = { elements: [], value: undefined };
            result.data.forEach(function (item, i) {
                var row = $('<tr id="' + id + i + '"></tr>');
                row.append(
                    $('<td>' + item.country + '</td>'),
                    $('<td>' + item.cost_5 + '</td>')
                );
                _boundItem.apply(maxItem, [item, 'max', row]);
                _boundItem.apply(minItem, [item, 'min', row]);
                bodyContent.push(row);
            });
            $('#cost-table-body').empty().append(bodyContent);

            if (bodyContent.length > 1 && maxItem.value != minItem.value) {
                _addClass.call(maxItem, 'danger');
                _addClass.call(minItem, 'success');
            }
        })
    }

    $(document).ready(function () {
        $('#country').typeahead({
            source: countries,
            afterSelect: function (item) {
                _loadCallCosts(item.toLowerCase())
            }
        })
    })
})();
